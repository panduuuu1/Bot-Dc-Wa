<!-- src/monitor/views/panel.ejs -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bot Monitoring Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f1720; color:#e6eef8; }
    .card { background:#0b1220; border:1px solid rgba(255,255,255,0.03); }
    .status-online { color:#4caf50; font-weight:600; }
    .status-offline { color:#f44336; font-weight:600; }
    pre.qr { white-space: pre-wrap; word-break: break-word; background:#071227; padding:12px; border-radius:6px; color:#dbeafe; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-3">ðŸ”§ Bot Monitoring Panel</h3>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="card p-3">
          <h5>WhatsApp</h5>
          <p>Status: <span id="wa-status" class="status-offline">loading...</span></p>
          <div id="wa-qr-area" style="display:none">
            <p><strong>QR (scan with WhatsApp):</strong></p>
            <img id="wa-qr-img" src="" alt="QR" style="max-width:260px;"/>
            <p class="mt-2"><small>If QR doesn't show, click <button id="wa-refresh-qr" class="btn btn-sm btn-outline-light">Refresh QR</button></small></p>
            <pre id="wa-qr-text" class="qr" style="display:none"></pre>
          </div>

          <div class="mt-3">
            <button id="wa-logout" class="btn btn-danger btn-sm">Logout WA</button>
            <button id="wa-restore" class="btn btn-secondary btn-sm">Restore Auth from DB</button>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <h5>Discord</h5>
          <p>Status: <span id="dc-status" class="status-offline">loading...</span></p>
          <div class="mt-3">
            <button id="dc-restart" class="btn btn-warning btn-sm">Restart Discord</button>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 card p-3">
      <h6>Actions / Notes</h6>
      <p>All sensitive actions require <code>x-api-token</code> header. Set <code>PANEL_API_TOKEN</code> in your server <code>.env</code> first.</p>
    </div>
  </div>

<script>
const API_TOKEN = '<%= apiTokenHeader ? "1" : "" %>'; // indicator only

async function fetchJson(url, opts = {}) {
  opts.headers = opts.headers || {};
  if (API_TOKEN && typeof API_TOKEN !== 'undefined') {
    // real token will be passed from the client via prompt or you can set fetch to include credentials
    // For security, in production use a login or secure cookie; here we read token from prompt when needed.
  }
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error('Request failed: ' + res.status);
  return res.json();
}

async function loadStatus() {
  try {
    const s = await fetchJson('/api/status');
    const wa = s.whatsapp || 'unknown';
    const dc = s.discord || 'unknown';

    const waEl = document.getElementById('wa-status');
    const dcEl = document.getElementById('dc-status');

    waEl.textContent = wa.toUpperCase();
    waEl.className = wa === 'connected' ? 'status-online' : 'status-offline';

    dcEl.textContent = dc.toUpperCase();
    dcEl.className = dc === 'online' ? 'status-online' : 'status-offline';

    // QR logic
    if (wa === 'qr' || wa === 'connecting') {
      // show QR area
      document.getElementById('wa-qr-area').style.display = 'block';
      loadQr();
    } else {
      document.getElementById('wa-qr-area').style.display = 'none';
    }
  } catch (e) {
    console.error("loadStatus err", e);
  }
}

async function loadQr() {
  try {
    const r = await fetchJson('/api/wa/qr');
    if (!r.qr) {
      document.getElementById('wa-qr-img').style.display = 'none';
      document.getElementById('wa-qr-text').style.display = 'block';
      document.getElementById('wa-qr-text').textContent = 'No QR string available yet.';
      return;
    }
    const encoded = encodeURIComponent(r.qr);
    const chartUrl = `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encoded}`;
    document.getElementById('wa-qr-img').src = chartUrl;
    document.getElementById('wa-qr-img').style.display = 'block';
    document.getElementById('wa-qr-text').style.display = 'none';
  } catch (e) {
    console.error("loadQr error", e);
  }
}

async function protectedPost(path) {
  const token = prompt('Enter PANEL API TOKEN (x-api-token header):');
  if (!token) return alert('Token required');
  const res = await fetch(path, {
    method: 'POST',
    headers: { 'x-api-token': token }
  });
  if (!res.ok) {
    const j = await res.json().catch(()=>({}));
    return alert('Action failed: ' + (j.error || res.status));
  }
  alert('Action executed successfully.');
  await loadStatus();
}

document.getElementById('wa-refresh-qr').addEventListener('click', loadQr);
document.getElementById('wa-logout').addEventListener('click', () => protectedPost('/api/wa/logout'));
document.getElementById('wa-restore').addEventListener('click', () => protectedPost('/api/wa/restore'));
document.getElementById('dc-restart').addEventListener('click', () => protectedPost('/api/discord/restart'));

setInterval(loadStatus, 3000);
loadStatus();
</script>
</body>
</html>
